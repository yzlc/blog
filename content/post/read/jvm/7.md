---
title: "第7章　虚拟机类加载机制"
date: 2020-05-27T10:32:33+08:00
tags: [jvm]
categories: [阅读]
draft: false
hiddenFromHomePage: true
---

## 7.2 类加载的时机
>加载（Loading）->连接（Linking）[验证（Verification）->准备（Preparation）->解析（Resolution）]->初始化（Initialization）->使用（Using）->卸载（Unloading）
- 顺序:加载、验证、准备、初始化和卸载这五个阶段的顺序是确定的，而解析阶段则不一定：它在某些情况下可以在初始化阶段之后再开始，这是为了支持Java语言的运行时绑定特性（也称为动态绑定或晚期绑定）,这些阶段通常都是互相交叉地混合进行的，会在一个阶段执行的过程中调用、激活另一个阶段
- 初始化有且仅有6种情况:
  1. 遇到new、getstatic、putstatic或invokestatic这四条字节码指令时，如果类型没有进行过初始化，则需要先触发其初始化阶段。能够生成这四条指令的典型Java代码场景有：
     - 使用new关键字实例化对象的时候。
     - 读取或设置一个类型的静态字段（被final修饰、已在编译期把结果放入常量池的静态字段除外）的时候。
     - 调用一个类型的静态方法的时候。
  2. 使用java.lang.reflect包的方法对类型进行反射调用的时候，如果类型没有进行过初始化，则需要先触发其初始化。
  3. 当初始化类的时候，如果发现其父类还没有进行过初始化，则需要先触发其父类的初始化。
  4. 当虚拟机启动时，用户需要指定一个要执行的主类（包含main()方法的那个类），虚拟机会先初始化这个主类。
  5. 当使用JDK 7新加入的动态语言支持时，如果一个java.lang.invoke.MethodHandle实例最后的解析结果为REF_getStatic、REF_putStatic、REF_invokeStatic、REF_newInvokeSpecial四种类型的方法句柄，并且这个方法句柄对应的类没有进行过初始化，则需要先触发其初始化。
  6. 当一个接口中定义了JDK 8新加入的默认方法（被default关键字修饰的接口方法）时，如果有
  这个接口的实现类发生了初始化，那该接口要在其之前被初始化。

## 7.3　类加载的过程
### 7.3.1　加载
- 过程
  1. 通过一个类的全限定名来获取定义此类的二进制字节流。
  2. 将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构。
  3. 在内存中生成一个代表这个类的java.lang.Class对象，作为方法区这个类的各种数据的访问入口。
- 非数组类型:既可以使用Java虚拟机里内置的引导类加载器来完成，也可以由用户自定义的类加载器去完成，开发人员通过定义自己的类加载器去控制字节流的获取方式（重写一个类加载器的findClass()或loadClass()方法），实现根据自己的想法来赋予应用程序获取运行代码的动态性。
- 数组类型:数组类本身不通过类加载器创建，它是由Java虚拟机直接在内存中动态构造出来的。但数组类与类加载器仍然有很密切的关系，因为数组类的元素类型（Element Type，去掉所有维度）最终还是要靠类加载器来完成加载，一个数组类（简称C）创建过程遵循以下规则：
  - 组件类型（Component Type，去掉一个维度）是引用类型:递归采用加载过程去加载这个组件类型，数组C将被标识在加载该组件类型的类加载器的类名称空间上
  - 组件类型不是引用类型:Java虚拟机将会把数组C标记为与引导类加载器关联。
  - 数组类的可访问性与它的组件类型的可访问性一致:如果组件类型不是引用类型，它的数组类的可访问性将默认为public，可被所有的类和接口访问到。
- 加载阶段结束后，Java虚拟机外部的二进制字节流就按照虚拟机所设定的格式存储在方法区之中了。类型数据妥善安置在方法区之后，会在Java堆内存中实例化一个java.lang.Class类的对象，这个对象将作为程序访问方法区中的类型数据的外部接口。
- 加载阶段与连接阶段的部分动作（如一部分字节码文件格式验证动作）是交叉进行的，加载阶段尚未完成，连接阶段可能已经开始，但这些夹在加载阶段之中进行的动作，仍然属于连接阶段的一部分，这两个阶段的开始时间仍然保持着固定的先后顺序。
### 7.3.2　验证
>确保Class文件的字节流中包含的信息符合《Java虚拟机规范》，被当作代码运行后不会危害虚拟机自身的安全
1. 文件格式验证
  - 是否以魔数0xCAFEBABE开头
  - 主、次版本号是否在当前Java虚拟机接受范围内
  - 
2. 元数据验证
3. 字节码验证
4. 符号引用验证